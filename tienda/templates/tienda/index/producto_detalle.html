{% extends 'tienda/index/base1.html' %}
{% load static %}

{% block title %}{{ producto.nombre }} - Motolux{% endblock %}

{% block content %}

<div class="container my-5">
    <!-- Breadcrumbs (Migas de pan) -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
            {% if producto.categoria %}
            <li class="breadcrumb-item"><a href="{% url 'productos_por_categoria' producto.categoria.id %}">{{ producto.categoria.nombre }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ producto.nombre }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Columna de la imagen del producto -->
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm border-0">
                <img src="{{ producto.imagen.url }}" class="card-img-top rounded" alt="{{ producto.nombre }}">
            </div>
        </div>

        <!-- Columna de los detalles del producto -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex flex-column">
                    <h1 class="card-title fw-bold">{{ producto.nombre }}</h1>
                    
                    <h2 class="precio my-3 text-danger fw-bolder">${{ producto.precio|floatformat:2 }}</h2>

                    <p class="card-text text-muted">{{ producto.descripcion|linebreaks }}</p>

                    <div class="mt-auto">
                        {% if producto.stock > 0 %}
                            <span class="badge bg-success mb-3">En stock ({{ producto.stock }} disponibles)</span>
                        {% else %}
                            <span class="badge bg-danger mb-3">Agotado</span>
                        {% endif %}

                        <div class="d-flex align-items-center gap-3 my-3">
                            <label for="quantity" class="form-label mb-0">Cantidad:</label>
                            <div class="input-group" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" id="decrease-qty">-</button>
                                <input type="text" class="form-control text-center" value="1" id="quantity-input" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="increase-qty">+</button>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-lg add-to-cart" 
                                    data-id="{{ producto.id }}"
                                    data-name="{{ producto.nombre }}" 
                                    data-price="{{ producto.precio }}"
                                    data-image="{{ producto.imagen.url }}" 
                                    {% if not producto.stock > 0 %}disabled{% endif %}>
                                <i class="bi bi-cart2"></i> Añadir al carrito
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Relacionados -->
    {% if productos_relacionados %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="fw-bold border-bottom pb-2 mb-4">También te podría interesar</h3>
        </div>
        {% for rel_producto in productos_relacionados %}
        <div class="col-6 col-md-4 col-lg-3 mb-4">
            <div class="card producto h-100">
                <a href="{% url 'producto_detalle' rel_producto.id %}">
                    <img src="{{ rel_producto.imagen.url }}" class="card-img-top" alt="{{ rel_producto.nombre }}">
                </a>
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">
                        <a href="{% url 'producto_detalle' rel_producto.id %}" class="text-dark text-decoration-none">{{ rel_producto.nombre }}</a>
                    </h6>
                    <p class="precio mt-auto">${{ rel_producto.precio|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('quantity-input');
    const increaseBtn = document.getElementById('increase-qty');
    const decreaseBtn = document.getElementById('decrease-qty');
    const addToCartBtn = document.querySelector('.add-to-cart');
    const stock = {{ producto.stock }};

    increaseBtn.addEventListener('click', () => {
        let currentQty = parseInt(qtyInput.value);
        if (currentQty < stock) {
            qtyInput.value = currentQty + 1;
        }
    });

    decreaseBtn.addEventListener('click', () => {
        let currentQty = parseInt(qtyInput.value);
        if (currentQty > 1) {
            qtyInput.value = currentQty - 1;
        }
    });

    // Modificamos la función global para que tome la cantidad del input
    function originalAddToCart(id, name, price, image) {
        const quantity = parseInt(qtyInput.value);
        const existing = cart.find(item => item.id === id);
        if (existing) {
            existing.quantity += quantity;
        } else {
            cart.push({ id, name, price: parseFloat(price), image: image, quantity: quantity });
        }
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartDisplay();
        // Opcional: mostrar una notificación o abrir el carrito
        new bootstrap.Offcanvas(document.getElementById('carritoOffcanvas')).show();
    }

    addToCartBtn.addEventListener('click', () => {
        originalAddToCart(
            addToCartBtn.dataset.id,
            addToCartBtn.dataset.name,
            addToCartBtn.dataset.price,
            addToCartBtn.dataset.image
        );
    });
});
</script>

{% endblock %}