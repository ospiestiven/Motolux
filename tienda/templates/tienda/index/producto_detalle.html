{% extends 'tienda/index/base1.html' %}
{% load static humanize %}

{% block title %}{{ producto.nombre }} - Motolux{% endblock %}

{% block content %}

<div class="container my-5">
    <!-- Breadcrumbs (Migas de pan) -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb align-items-center">
            <li class="breadcrumb-item">
                <a href="{% url 'index' %}" class="text-dark text-decoration-none breadcrumb-link">
                    <i class="bi bi-house"></i> Inicio
                </a>
            </li>
    
            {% if producto.categoria %}
            <li class="breadcrumb-item">
                <a href="{% url 'productos_por_categoria' producto.categoria.id %}"
                    class="text-dark text-decoration-none breadcrumb-link">
                    <i class="bi bi-folder"></i> {{ producto.categoria.nombre }}
                </a>
            </li>
            {% endif %}
    
            <li class="breadcrumb-item active text-muted" aria-current="page">
                <i class="bi bi-box-seam"></i> {{ producto.nombre }}
            </li>
        </ol>
    </nav>


    <div class="row">
        <!-- Columna de la imagen del producto -->
        <div class="col-md-6 mb-4">
            <!-- Imagen Principal -->
            <div class="mb-3">
                <img id="main-product-image" src="{{ producto.imagen.url }}" class="img-fluid rounded shadow-sm w-100" alt="{{ producto.nombre }}" style="max-height: 500px; object-fit: cover;">
            </div>

            <!-- Miniaturas -->
            {% if producto.imagen or imagenes_adicionales %}
            <div class="d-flex flex-wrap gap-2">
                <!-- Miniatura de la imagen principal -->
                {% if producto.imagen %}
                <div class="thumbnail-container">
                    <img src="{{ producto.imagen.url }}" class="img-thumbnail active" alt="Imagen principal" 
                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                         onclick="changeMainImage('{{ producto.imagen.url }}', this)">
                </div>
                {% endif %}
                <!-- Miniaturas de las imágenes adicionales -->
                {% for img_adicional in imagenes_adicionales %}
                <div class="thumbnail-container">
                    <img src="{{ img_adicional.imagen.url }}" class="img-thumbnail" alt="Miniatura {{ forloop.counter }}" 
                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                         onclick="changeMainImage('{{ img_adicional.imagen.url }}', this)">
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <style>
                .img-thumbnail.active {
                    border: 2px solid #DD0B15;
                }
            </style>
        </div>

        <!-- Columna de los detalles del producto -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex flex-column">
                    <h1 class="card-title fw-bold">{{ producto.nombre }}</h1>
                    {% if producto.modelo %}
                        <p class="text-muted mb-2"><strong>Modelo:</strong> {{ producto.modelo }}</p>
                    {% endif %}
                    
                    <h2 class="precio my-3 text-danger fw-bolder">${{ producto.precio|intcomma }}</h2>

                    <div class="mt-auto">
                        {% if producto.stock > 0 %}
                            <span class="badge bg-success mb-3">En stock ({{ producto.stock }} disponibles)</span>
                        {% else %}
                            <span class="badge bg-danger mb-3">Agotado</span>
                        {% endif %}

                        <div class="d-flex align-items-center gap-3 my-3">
                            <label for="quantity" class="form-label mb-0">Cantidad:</label>
                            <div class="input-group" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" id="decrease-qty">-</button>
                                <input type="text" class="form-control text-center" value="1" id="quantity-input" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="increase-qty">+</button>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-lg add-to-cart" 
                                    data-id="{{ producto.id }}"
                                    data-name="{{ producto.nombre }}"
                                    data-name="{{ producto.modelo }}"
                                    data-price="{{ producto.precio }}"
                                    data-image="{{ producto.imagen.url }}" 
                                    {% if not producto.stock > 0 %}disabled{% endif %}>
                                <i class="bi bi-cart2"></i> Añadir al carrito
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Descripción -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">Descripción del Producto</h5>
                </div>
                <div class="card-body p-4">
                    <p class="card-text text-muted">{{ producto.descripcion|linebreaks }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Relacionados -->
    {% if productos_relacionados %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="fw-bold border-bottom pb-2 mb-4">También te podría interesar</h3>
        </div>
        {% for rel_producto in productos_relacionados %}
        <div class="col-6 col-md-4 col-lg-3 mb-4">
            <div class="card producto h-100">
                <a href="{% url 'producto_detalle' rel_producto.id %}">
                    <div class="img-container">
                        <img src="{{ rel_producto.imagen.url }}" class="card-img-top product-card-img" alt="{{ rel_producto.nombre }}">
                    </div>
                </a>
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">
                        <a href="{% url 'producto_detalle' rel_producto.id %}" class="text-dark text-decoration-none">{{ rel_producto.nombre }}</a>
                    </h6>
                    <p class="precio mt-auto">${{ rel_producto.precio|intcomma }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<style>
    .img-container {
        width: 100%;
        height: 225px; /* O la altura que prefieras, ej: 200px */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: #f8f9fa;
    }

    .product-card-img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* La magia está aquí */
        object-position: center;
    }
</style>


<script>
    function changeMainImage(newSrc, clickedThumbnail) {
        // Cambia la imagen principal
        document.getElementById('main-product-image').src = newSrc;

        // Actualiza el borde activo en las miniaturas
        const thumbnails = document.querySelectorAll('.thumbnail-container img');
        thumbnails.forEach(thumb => {
            thumb.classList.remove('active');
            if (thumb === clickedThumbnail) {
                thumb.classList.add('active');
            } else {
                thumb.classList.remove('active');
            }
        });
    }

    
        document.addEventListener('DOMContentLoaded', function () {
        const qtyInput = document.getElementById('quantity-input');
            const increaseBtn = document.getElementById('increase-qty');
            const decreaseBtn = document.getElementById('decrease-qty');
            const addToCartBtn = document.querySelector('.add-to-cart');
            const stock = parseInt("{{ producto.stock }}", 10) || 0;

        increaseBtn.addEventListener('click', () => {
                let currentQty = parseInt(qtyInput.value, 10);
            if (currentQty < stock) qtyInput.value = currentQty + 1;
        });

        decreaseBtn.addEventListener('click', () => {
                let currentQty = parseInt(qtyInput.value, 10);
            if (currentQty > 1) qtyInput.value = currentQty - 1;
        });

            // lee carrito global (definido en base1.html)
            let cart = JSON.parse(localStorage.getItem("cart")) || [];

            function saveCart() {
                localStorage.setItem("cart", JSON.stringify(cart));
        }

            function updateCartDisplaySafe() {
            if (typeof updateCartDisplay === 'function') {
                try {updateCartDisplay(); } catch (e) {console.warn(e); }
            }
        }

            function originalAddToCart(id, name, price, image) {
            const quantity = Number(qtyInput.value) || 1;
            const idStr = String(id);
            const existing = cart.find(item => String(item.id) === idStr);
            if (existing) {
                existing.quantity = Number(existing.quantity || 0) + quantity;
            } else {
                cart.push({ id: idStr, name: name, price: parseFloat(price) || 0, image: image || '', quantity: quantity });
            }
            saveCart();
            updateCartDisplaySafe();
            // abrir offcanvas si se desea (mantener comportamiento actual)
            try {new bootstrap.Offcanvas(document.getElementById('carritoOffcanvas')).show(); } catch (err) { }
        }

        addToCartBtn.addEventListener('click', (e) => {
                // evita que otros listeners (p. ej. el global en base1.html) también ejecuten
                e.preventDefault();
            e.stopImmediatePropagation();

            // evitar doble click rápido
            if (addToCartBtn.disabled) return;
            addToCartBtn.disabled = true;

            originalAddToCart(
            addToCartBtn.dataset.id,
            addToCartBtn.dataset.name,
            addToCartBtn.dataset.price,
            addToCartBtn.dataset.image
            );

            // feedback breve y reactivar botón
            const originalHTML = addToCartBtn.innerHTML;
            addToCartBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Añadido';
            addToCartBtn.classList.remove('btn-danger');
            addToCartBtn.classList.add('btn-success');

            setTimeout(() => {
                addToCartBtn.innerHTML = originalHTML;
            addToCartBtn.classList.remove('btn-success');
            addToCartBtn.classList.add('btn-danger');
            addToCartBtn.disabled = false;
            }, 900);
        });
    });
    
</script>


{% endblock %}