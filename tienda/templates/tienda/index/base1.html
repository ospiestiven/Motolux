<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motolux</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <link rel="stylesheet" href="{% static 'css/styles.css' %}" >
    
</head>
<body>
    <header class="header ">
        <ul class="nav-lista">
            
            <li class="nav-item">
                <a href="{% url 'index' %}" >
                    <img src="{% static 'img/logoEnBlanco.png' %}" alt="Logo Motolux" class="logo">
                </a>
            </li>
            
            
            
            <!-- buscador -->
            <form action="" method="get" class="d-flex" style="width: 300px;">
                <div class="input-group">
                    <input class="form-control" type="search" name="q" placeholder="Buscar productos..." aria-label="Search">
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="bi bi-search"></i> 
                    </button>
                </div>
            </form>

            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="offcanvas" href="#carritoOffcanvas" role="button"
                    aria-controls="carritoOffcanvas">
                    <i class="bi bi-cart2"></i> Carrito
                    <span class="badge bg-danger" id="cart-count">0</span>
                </a>
            </li>

            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle me-1"></i>
                    <span class="fw-bold">{{ request.user.username|default:"Invitado" }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    {% if request.user.is_authenticated %}
                    <li>
                        <a class="dropdown-item" href="{% url 'perfil' %}">
                            <i class="bi bi-person-fill me-2"></i> Mi Perfil
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'account_logout' %}">
                            <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesiÃ³n
                        </a>
                    </li>
                    {% else %}
                    <li>
                        <a class="dropdown-item" href="{% url 'account_login' %}">
                            <i class="bi bi-box-arrow-in-right me-2"></i> Ingresar / Registrarse
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            
            
        </ul>
    </header>
    <!-- Carrito Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="carritoOffcanvas" aria-labelledby="carritoOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="carritoOffcanvasLabel">ðŸ›’ Mi Carrito</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" id="cart-items">
            <p class="text-muted">Tu carrito estÃ¡ vacÃ­o.</p>
        </div>
        <div class="offcanvas-footer p-3 border-top">
            <h5>Total: $<span id="cart-total">0</span></h5>
            <a href="{% url 'detalles_facturacion' %}" class="btn btn-danger w-100 mt-2">Finalizar Compra</a>
        </div>
    </div>

    {% block content %}
    {% endblock %}


    <script>
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById("cart-items");
            const cartTotal = document.getElementById("cart-total");
            const cartCount = document.getElementById("cart-count");

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = "<p class='text-muted'>Tu carrito estÃ¡ vacÃ­o.</p>";
                cartTotal.textContent = "0";
                cartCount.textContent = "0";
                return;
            }

            cartItemsContainer.innerHTML = "";
            let total = 0;

            cart.forEach((item, index) => {
                let subtotal = item.price * item.quantity;
                total += subtotal;

                cartItemsContainer.innerHTML += `
            <div class="d-flex align-items-center border-bottom py-2">
              <img src="${item.image}" alt="${item.name}" class="me-2 rounded" style="width: 60px; height: 60px; object-fit: cover;">
              <div class="flex-grow-1">
                <strong>${item.name}</strong><br>
                <small>$${item.price} c/u</small><br>
                <small>Subtotal: <span class="text-danger">$${subtotal.toFixed(2)}</span></small>
              </div>
              <div class="d-flex flex-column align-items-center gap-1">
                <button class="btn btn-sm btn-outline-secondary" onclick="increaseQuantity(${index})">âž•</button>
                <span>${item.quantity}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="decreaseQuantity(${index})">âž–</button>
                <button class="btn btn-sm btn-danger mt-1" onclick="removeFromCart(${index})">ðŸ—‘</button>
              </div>
            </div>
          `;
            });

            cartTotal.textContent = total.toFixed(2);
            cartCount.textContent = cart.reduce((acc, item) => acc + item.quantity, 0);
        }

        function addToCart(id, name, price, image) {
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, name, price: parseFloat(price), image: image, quantity: 1 });
            }
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartDisplay();
        }

        function increaseQuantity(index) {
            cart[index].quantity++;
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartDisplay();
        }

        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartDisplay();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartDisplay();
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".add-to-cart").forEach(button => {
                button.addEventListener("click", () => {
                    const id = button.dataset.id;
                    const name = button.dataset.name;
                    const price = button.dataset.price;
                    const image = button.dataset.image;
                    addToCart(id, name, price, image);
                });
            });

            updateCartDisplay();
        });
    </script>



<!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>